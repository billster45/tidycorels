<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corels vs XGBoost • tidycorels</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Corels vs XGBoost">
<meta property="og:description" content="tidycorels">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidycorels</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/diabetes_example.html">Corels vs Random Forest</a>
    </li>
    <li>
      <a href="../articles/german_credit_data_example.html">Corels vs XGBoost</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="german_credit_data_example_files/kePrint-0.0.1/kePrint.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Corels vs XGBoost</h1>
            
            <h4 class="date">2020-07-25</h4>
      
      
      <div class="hidden name"><code>german_credit_data_example.Rmd</code></div>

    </div>

    
    
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>The performance of <a href="https://corels.eecs.harvard.edu/">Corels</a> on test data is compared to <a href="https://xgboost.readthedocs.io/en/latest/R-package/xgboostPresentation.html">XGboost</a>.</p>
<p>Precision is an important metric for loan decisions (i.e. when a good loan is predicted, how often it is true). In this example, on unseen test data, XGBoost achieves <strong>84%</strong> accuarcy (106 / (106 + 20)) vs. <strong>78%</strong> (117/(117+34)) for Corels. The null accuracy (always predicting the most frequent class of a good loan) is <strong>73%</strong> (142 / (142 + 52).</p>
<p>While XGBoost performs better, the Corels rules are short and easy to interpret. Also, the accuracy achieved by the two methods is more similar (XGBoost <strong>72%</strong> vs. Corels <strong>70%</strong>).</p>
</div>
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<blockquote>
<p>Corels are <a href="https://corels.eecs.harvard.edu/">‘Certifiably Optimal RulE ListS’</a>. They are short and simple human <a href="https://arxiv.org/pdf/1704.01701.pdf">interpretable rule lists</a> created on categorical data.</p>
</blockquote>
<p>This analysis compares the performance of a simple Corels rule set to xgboost on German credit data.</p>
<p>The xgboost modelling of the <a href="https://www.openml.org/d/31">german credit data</a> is adapted from this excellent test of <a href="https://github.com/hamedbh/test-drake-tidymodels">tidymodels with drake</a>.</p>
</div>
<div id="data-preparation" class="section level1">
<h1 class="hasAnchor">
<a href="#data-preparation" class="anchor"></a>Data Preparation</h1>
<div id="data-source" class="section level2">
<h2 class="hasAnchor">
<a href="#data-source" class="anchor"></a>Data source</h2>
<p>The <a href="https://www.openml.org/d/31">german credit data</a> is downloaded and prepared using the code in <a href="https://github.com/hamedbh/test-drake-tidymodels">tidymodels with drake</a>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidymodels</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">corels</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidycorels</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">funModeling</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">pROC</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">formattable</span>)

<span class="no">clean_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="st">"https://www.openml.org/data/get_csv/31/dataset_31_credit-g.arff"</span>,
                       <span class="kw">header</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                       <span class="kw">sep</span> <span class="kw">=</span> <span class="st">","</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">janitor</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span>(<span class="no">.</span>, <span class="st">"small_camel"</span>)</pre></body></html></div>
</div>
<div id="data-splitting" class="section level2">
<h2 class="hasAnchor">
<a href="#data-splitting" class="anchor"></a>Data Splitting</h2>
<p>We first <a href="https://rsample.tidymodels.org/articles/Applications/Recipes_and_rsample.html">split</a> the data into 80% training data and 20% test to evaluate the final model chosen. Folds of the training data are also created for cross-validation when building a classifier with xgboost.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">seed</span> <span class="kw">=</span> <span class="fl">943</span>)
<span class="no">training_split</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">rsample</span><span class="kw ns">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">initial_split</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">clean_df</span>,
    <span class="kw">prop</span> <span class="kw">=</span> <span class="fl">0.8</span>
  )

<span class="no">trainData</span> <span class="kw">&lt;-</span> <span class="kw pkg">rsample</span><span class="kw ns">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span>(<span class="no">training_split</span>)
<span class="no">testData</span> <span class="kw">&lt;-</span> <span class="kw pkg">rsample</span><span class="kw ns">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing</a></span>(<span class="no">training_split</span>)

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">seed</span> <span class="kw">=</span> <span class="fl">1738</span>)
<span class="no">folds</span> <span class="kw">&lt;-</span> <span class="kw pkg">rsample</span><span class="kw ns">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span>(<span class="no">trainData</span>,
  <span class="kw">v</span> <span class="kw">=</span> <span class="fl">5</span>
)</pre></body></html></div>
</div>
<div id="data-exploration" class="section level2">
<h2 class="hasAnchor">
<a href="#data-exploration" class="anchor"></a>Data exploration</h2>
<p>Let’s quickly explore the <a href="https://livebook.datascienceheroes.com/exploratory-data-analysis.html#selecting_best_vars_mic">relationships</a> between each predictor and the outcome of a good or bad loan.</p>
<p>We use the funModels package to bin or categorise numeric predictors to <a href="https://blog.datascienceheroes.com/discretization-recursive-gain-ratio-maximization/">maximise the information gain ratio</a>. From this we can more easily <em>“semantically describe the relationship between the input and the target variable”</em>.</p>
<p>We also store the cut points of the categorised continuous columns to be used later when categorsing values for Corels.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># https://blog.datascienceheroes.com/discretization-recursive-gain-ratio-maximization/</span>
<span class="no">trainData_cat</span> <span class="kw">&lt;-</span>
  <span class="no">trainData</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">:::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span>(
    <span class="kw">.cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">duration</span>, <span class="no">creditAmount</span>,<span class="no">age</span>),
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(~ <span class="kw pkg">funModeling</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/funModeling/man/discretize_rgr.html">discretize_rgr</a></span>(<span class="kw">input</span> <span class="kw">=</span> <span class="no">.</span>, <span class="kw">target</span> <span class="kw">=</span> <span class="no">class</span>)),
    <span class="kw">.names</span> <span class="kw">=</span> <span class="st">"{col}Cat"</span>
  ))

<span class="no">vars</span> <span class="kw">&lt;-</span> <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">trainData_cat</span>, <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">contains</a></span>(<span class="st">"Cat"</span>)))

<span class="no">age_cat_cuts</span> <span class="kw">&lt;-</span>
  <span class="no">trainData_cat</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">ageCat</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="kw">min</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">age</span>), <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(<span class="no">min</span>)

<span class="no">duration_cat_cuts</span> <span class="kw">&lt;-</span>
  <span class="no">trainData_cat</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">durationCat</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="kw">min</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">duration</span>), <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(<span class="no">min</span>)

<span class="no">amount_cat_cuts</span> <span class="kw">&lt;-</span>
  <span class="no">trainData_cat</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">creditAmountCat</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="kw">min</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">creditAmount</span>), <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(<span class="no">min</span>)</pre></body></html></div>
<p>This function will plot each predictor against the outcome.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">plot_fun</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">cat</span>) {
  <span class="no">cat</span> <span class="kw">&lt;-</span> <span class="kw pkg">rlang</span><span class="kw ns">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">ensym</a></span>(<span class="no">cat</span>)

  <span class="no">trainData_cat</span> <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(!!<span class="no">cat</span>, <span class="no">class</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu">n</span>(), <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">'drop'</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
      <span class="kw">x</span> <span class="kw">=</span> !!<span class="no">cat</span>,
      <span class="kw">y</span> <span class="kw">=</span> <span class="no">n</span>,
      <span class="kw">fill</span> <span class="kw">=</span> <span class="no">class</span>,
      <span class="kw">label</span> <span class="kw">=</span> <span class="no">n</span>
    ) +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(
      <span class="kw">position</span> <span class="kw">=</span> <span class="st">"fill"</span>,
      <span class="kw">stat</span> <span class="kw">=</span> <span class="st">"identity"</span>
    ) +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(
      <span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>,
      <span class="kw">position</span> <span class="kw">=</span> <span class="fu">position_fill</span>(<span class="kw">vjust</span> <span class="kw">=</span> <span class="fl">0.5</span>),
      <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>
    ) +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>() +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>() +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">labels</span> <span class="kw">=</span> <span class="kw pkg">scales</span><span class="kw ns">::</span><span class="no"><a href="https://scales.r-lib.org//reference/label_percent.html">percent</a></span>) +
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
      <span class="kw">panel.grid.major.x</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
      <span class="kw">panel.grid.minor.x</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
      <span class="kw">panel.border</span> <span class="kw">=</span> <span class="fu">element_blank</span>(),
      <span class="kw">strip.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">10</span>),
      <span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_text</span>(
        <span class="co"># angle = 60,</span>
        <span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">1</span>,
        <span class="kw">size</span> <span class="kw">=</span> <span class="fl">10</span>
      ),
      <span class="kw">legend.text</span> <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">12</span>),
      <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"right"</span>,
      <span class="kw">legend.direction</span> <span class="kw">=</span> <span class="st">"vertical"</span>,
      <span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu">element_text</span>(
        <span class="kw">size</span> <span class="kw">=</span> <span class="fl">22</span>,
        <span class="kw">face</span> <span class="kw">=</span> <span class="st">"bold"</span>
      )
    )
}</pre></body></html></div>
<p>In each plot below we can view the relationships between each predictor and outcome. Variables that have the most variation in the ratio between good and bad loans we would expect them to feature in the classification models.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">cols</span> <span class="kw">&lt;-</span> <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">trainData_cat</span>, -<span class="no">duration</span>, -<span class="no">age</span>, -<span class="no">creditAmount</span>)) <span class="co"># getting all the column names but removing the continuous columns that have been binned.</span>
<span class="no">cols</span> <span class="kw">&lt;-</span> <span class="no">cols</span>[<span class="no">cols</span> <span class="kw">!=</span> <span class="st">"class"</span>] <span class="co"># remove outcome column from list of column names</span>
<span class="no">plots</span> <span class="kw">&lt;-</span> <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">cols</span>, <span class="no">plot_fun</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">plots</span>)
<span class="co">#&gt; [[1]]</span></pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[2]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[3]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-3.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[4]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-4.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[5]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-5.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[6]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-6.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[7]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-7.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[8]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-8.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[9]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-9.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[10]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-10.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[11]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-11.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[12]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-12.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[13]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-13.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[14]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-14.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[15]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-15.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[16]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-16.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[17]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-17.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[18]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-18.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[19]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-19.png" width="700"></p>
<pre><code>#&gt; 
#&gt; [[20]]</code></pre>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-5-20.png" width="700"></p>
</div>
</div>
<div id="corels" class="section level1">
<h1 class="hasAnchor">
<a href="#corels" class="anchor"></a>CORELS</h1>
<div id="prepare-data-for-corels" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-data-for-corels" class="anchor"></a>Prepare data for Corels</h2>
<p>Using the recipes package in <a href="https://www.tidymodels.org/">tidymodels</a> we create a recipe that converts the three continuous value columns into categories, then convert the values in every column into individual dummy fields per value.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="co"># create the data preperation recipe</span>
<span class="no">credit_recipe</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">class</span> ~ <span class="no">.</span>,
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">trainData</span>
  ) <span class="kw">%&gt;%</span>
  <span class="co"># 1 Apply the funModeling::discretize_rgr() cut points to continuous columns that maximise the information gain ratio on the training data only</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span>(<span class="kw">age</span> <span class="kw">=</span> <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">age</span>, <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"-inf"</span>, <span class="no">age_cat_cuts</span>, <span class="st">"inf"</span>), <span class="kw">right</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">dig.lab</span> <span class="kw">=</span> <span class="fl">10</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span>(<span class="kw">duration</span> <span class="kw">=</span> <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">duration</span>, <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"-inf"</span>, <span class="no">duration_cat_cuts</span>, <span class="st">"inf"</span>), <span class="kw">right</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">dig.lab</span> <span class="kw">=</span> <span class="fl">10</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span>(<span class="kw">creditAmount</span> <span class="kw">=</span> <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(<span class="no">creditAmount</span>, <span class="kw">breaks</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"-inf"</span>, <span class="no">amount_cat_cuts</span>, <span class="st">"inf"</span>), <span class="kw">right</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">dig.lab</span> <span class="kw">=</span> <span class="fl">10</span>)) <span class="kw">%&gt;%</span>
  <span class="co"># 2 ensure column values that are words do not have spaces. This will form better dummy column names that tidycorels needs where the value each dummy column represents is shown by a single delimiter (e.g. the underscore step_dummy creates)</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate_at.html">step_mutate_at</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span>(), <span class="kw">fn</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(~ <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"_"</span>, <span class="kw">replacement</span> <span class="kw">=</span> <span class="st">"."</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="no">.</span>))) <span class="kw">%&gt;%</span>
  <span class="co"># 3 convert each value of each predictor into its own 0/1 binary column</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate_at.html">step_mutate_at</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span>(), <span class="kw">fn</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(~ <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">.</span>))) <span class="kw">%&gt;%</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span>(<span class="kw">class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">class</span>)) <span class="kw">%&gt;%</span> <span class="co"># step_dummy requires variable values to be factors</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span>(), <span class="kw">one_hot</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="kw">%&gt;%</span>
  <span class="co"># 4 convert each value of the outcome column into its own 0/1 binary column</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_integer.html">step_integer</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>(), <span class="kw">zero_based</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="kw">%&gt;%</span> <span class="co"># ensure outcome is 0/1 rather than words</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate_at.html">step_mutate_at</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>(), <span class="kw">fn</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(~ <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">.</span>))) <span class="kw">%&gt;%</span> <span class="co"># step_dummy requires variable values to be factors</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>(), <span class="kw">one_hot</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Train the data preperation recipe on the training data</span>
<span class="no">credit_recipe_trained</span> <span class="kw">&lt;-</span> <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>(<span class="no">credit_recipe</span>,
                                       <span class="kw">training</span> <span class="kw">=</span> <span class="no">trainData</span>,
                                       <span class="kw">retain</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Extract the train data with recipe applied (juice), and the same recipe applied to the test data (bake) data</span>
<span class="no">credit_train_preprocessed</span> <span class="kw">&lt;-</span> <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/juice.html">juice</a></span>(<span class="no">credit_recipe_trained</span>)
<span class="no">credit_test_preprocessed</span> <span class="kw">&lt;-</span> <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span>(<span class="no">credit_recipe_trained</span>,
                                          <span class="kw">new_data</span> <span class="kw">=</span> <span class="no">testData</span>)</pre></body></html></div>
</div>
<div id="run-tidycorels" class="section level2">
<h2 class="hasAnchor">
<a href="#run-tidycorels" class="anchor"></a>Run tidycorels</h2>
<p>We can now run <code><a href="../reference/tidy_corels.html">tidycorels::tidy_corels()</a></code> function on the prepared training data. We could consider varying the regularization argument in corels. This value, <em>“can be thought of as a penalty equivalent to misclassifying 1% of the data when increasing the length of a rule list by one association rule.”</em> When the regulraization value is low many rules are created that could <a href="https://en.wikipedia.org/wiki/Overfitting">overfit</a> to error in the training data. A higher value leads to fewer rules which may generalise better to unseen test data. Here we simply use the default value of 0.01 that leads to a small number of rules.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">credit_train_model</span> <span class="kw">&lt;-</span>
    <span class="kw pkg">tidycorels</span><span class="kw ns">::</span><span class="fu"><a href="../reference/tidy_corels.html">tidy_corels</a></span>(
      <span class="kw">df</span> <span class="kw">=</span> <span class="no">credit_train_preprocessed</span>,
      <span class="kw">label_cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"class_X0"</span>, <span class="st">"class_X1"</span>),
      <span class="kw">value_delim</span> <span class="kw">=</span> <span class="st">"_"</span>,
      <span class="kw">run_bfs</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
      <span class="kw">calculate_size</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
      <span class="kw">run_curiosity</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
      <span class="kw">regularization</span> <span class="kw">=</span> <span class="fl">0.01</span>,
      <span class="kw">curiosity_policy</span> <span class="kw">=</span> <span class="fl">3</span>
    )
<span class="no">credit_train_model</span>$<span class="no">corels_console_output</span>[<span class="fl">4</span>:<span class="fl">8</span>]</pre></body></html></div>
<p>A dataframe of just the true label, the columns used in the Corels rules, and the Corels predictions is returned. The columns have been ordered for you to work well in an <a href="https://github.com/erblast/easyalluvial/blob/master/README.md">alluvial</a> plot.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="kw pkg">easyalluvial</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/easyalluvial/man/alluvial_wide.html">alluvial_wide</a></span>(<span class="no">credit_train_model</span>$<span class="no">alluvial_df</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>()</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div id="corels-performance-on-test" class="section level2">
<h2 class="hasAnchor">
<a href="#corels-performance-on-test" class="anchor"></a>Corels performance on test</h2>
<p>Next we use the function <code>tidycorels::corels_predict()</code> to apply the Corels rules created on the training data to the test data that has already been pre-processed using the recipe created on the training data.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">credit_test_predict</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">tidycorels</span><span class="kw ns">::</span><span class="fu"><a href="../reference/predict_corels.html">predict_corels</a></span>(
    <span class="kw">model</span> <span class="kw">=</span> <span class="no">credit_train_model</span>,
    <span class="kw">new_df</span> <span class="kw">=</span> <span class="no">credit_test_preprocessed</span>
  )</pre></body></html></div>
<p>We can now use the test data that has been labelled using the Corels rules and compare this to the true label to create a confusion matrix along with performance statistics.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">conf_matrix</span> <span class="kw">&lt;-</span>
  <span class="no">credit_test_predict</span>$<span class="no">new_df_labelled</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/conf_mat.html">conf_mat</a></span>(
    <span class="kw">truth</span> <span class="kw">=</span> <span class="st">"class_X1"</span>,
    <span class="kw">estimate</span> <span class="kw">=</span> <span class="st">"corels_label"</span>
  )

<span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">conf_matrix</span>, <span class="st">"heatmap"</span>)</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode" id="cb30"><html><body><pre class="r">
<span class="co"># https://github.com/tidymodels/yardstick/issues/160</span>
<span class="kw pkg">withr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/withr/man/with_options.html">with_options</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">yardstick.event_first</span> <span class="kw">=</span> <span class="fl">FALSE</span>),<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">conf_matrix</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">:::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.estimate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">.estimate</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">.metric</span>, <span class="no">.estimate</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">.metric</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"accuracy"</span>,<span class="st">"bal_accuracy"</span>, <span class="st">"mcc"</span>,<span class="st">"precision"</span>, <span class="st">"recall"</span>, <span class="st">"f_meas"</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.estimate</span> <span class="kw">=</span> <span class="kw pkg">formattable</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/formattable/man/color_tile.html">color_tile</a></span>(<span class="st">"white"</span>, <span class="st">"orange"</span>)(<span class="no">.estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">escape</span> <span class="kw">=</span> <span class="no">F</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></body></html></div>
<table class="table table table-hover">
<thead><tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimate
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
accuracy
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffb734">0.704</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
mcc
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.240</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
bal_accuracy
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffc55b">0.614</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffac15">0.775</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffa500">0.824</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
f_meas
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffa80a">0.799</span>
</td>
</tr>
</tbody>
</table>
<p>Because, <em>“It is worse to class a customer as good when they are bad (5), than it is to class a customer as bad when they are good (1).”</em> (<a href="https://archive.ics.uci.edu/ml/datasets/Statlog+(German+Credit+Data)">see</a>), precision is a useful metric. It measures the proportion of True Positives (117 labelled good loans that were actually good), out of the True Positives plus False Positives (34 labelled good loans that were actually bad). This is the bottom row of the confusion matrix: 117 / (117 + 34) = 0.775.</p>
<p>By inspecting the alluvial plot on test data we can easily see where and why the rules have succeeded or failed to label the unseen test data correctly.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="kw pkg">easyalluvial</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/easyalluvial/man/alluvial_wide.html">alluvial_wide</a></span>(<span class="no">credit_test_predict</span>$<span class="no">alluvial_df</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span>()</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
</div>
<div id="xgbboost" class="section level1">
<h1 class="hasAnchor">
<a href="#xgbboost" class="anchor"></a>XGBboost</h1>
<p>Next we try XGBoost that is a Gradient Boosting Method:</p>
<p><em>“GBMs build an ensemble of shallow trees in sequence with each tree learning and improving on the previous one. Although shallow trees by themselves are rather weak predictive models, they can be “boosted” to produce a powerful “committee” that, when appropriately tuned, is often hard to beat with other algorithms."</em> From <a href="https://bradleyboehmke.github.io/HOML/gbm.html">“Hands on Machine Learning with R”</a></p>
<div id="data-recipe" class="section level2">
<h2 class="hasAnchor">
<a href="#data-recipe" class="anchor"></a>Data recipe</h2>
<p>In the data recipe only the categorical columns are one-hot encoded into one column per value.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">xgb_pre_proc</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">class</span> ~ <span class="no">.</span>,
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">trainData</span>
  ) <span class="kw">%&gt;%</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span>(<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_nominal</a></span>(),
    -<span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_outcomes</a></span>(),
    <span class="kw">one_hot</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></body></html></div>
</div>
<div id="define-model-and-its-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#define-model-and-its-parameters" class="anchor"></a>Define model and its parameters</h2>
<p>Here we define which <a href="https://parsnip.tidymodels.org/reference/boost_tree.html">boost tree parameters</a> will be tuned later and which we fix.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="no">xgb_mod</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">parsnip</span><span class="kw ns">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/boost_tree.html">boost_tree</a></span>(
    <span class="kw">mtry</span> <span class="kw">=</span> <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/tune.html">tune</a></span>(),
    <span class="kw">trees</span> <span class="kw">=</span> <span class="fl">500</span>,
    <span class="kw">min_n</span> <span class="kw">=</span> <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/tune.html">tune</a></span>(),
    <span class="kw">tree_depth</span> <span class="kw">=</span> <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/tune.html">tune</a></span>(),
    <span class="kw">learn_rate</span> <span class="kw">=</span> <span class="fl">0.01</span>,
    <span class="kw">sample_size</span> <span class="kw">=</span> <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/tune.html">tune</a></span>()
  ) <span class="kw">%&gt;%</span>
  <span class="kw pkg">parsnip</span><span class="kw ns">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span>(<span class="st">"classification"</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">parsnip</span><span class="kw ns">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span>(<span class="st">"xgboost"</span>)</pre></body></html></div>
</div>
<div id="add-recipe-and-model-to-a-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#add-recipe-and-model-to-a-workflow" class="anchor"></a>Add recipe and model to a workflow</h2>
<p>The workflow is therefore the data preparation recipe and the model specification (including its type and which parameters are to be tuned later).</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">xgb_wflow</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">workflows</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/workflows/man/workflow.html">workflow</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">workflows</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/workflows/man/add_recipe.html">add_recipe</a></span>(<span class="no">xgb_pre_proc</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">workflows</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/workflows/man/add_model.html">add_model</a></span>(<span class="no">xgb_mod</span>)</pre></body></html></div>
</div>
<div id="define-model-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#define-model-parameters" class="anchor"></a>Define model parameters</h2>
<p>Let’s now define the parameters by looking at the workflow</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="no">xgb_wflow</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dials</span><span class="kw ns">::</span><span class="fu"><a href="https://dials.tidymodels.org/reference/parameters.html">parameters</a></span>()
<span class="co">#&gt; Collection of 4 parameters for tuning</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;           id parameter type object class</span>
<span class="co">#&gt;         mtry           mtry    nparam[?]</span>
<span class="co">#&gt;        min_n          min_n    nparam[+]</span>
<span class="co">#&gt;   tree_depth     tree_depth    nparam[+]</span>
<span class="co">#&gt;  sample_size    sample_size    nparam[+]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model parameters needing finalization:</span>
<span class="co">#&gt;    # Randomly Selected Predictors ('mtry')</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; See `?dials::finalize` or `?dials::update.parameters` for more information.</span></pre></body></html></div>
<p><code>mtry</code> is the number of predictors that will be randomly sampled at each split when creating the tree models. This is set to range between 40% of the features to all of the features.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="no">feat_count</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">xgb_pre_proc</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">recipes</span><span class="kw ns">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/juice.html">juice</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">class</span>))

<span class="no">mtry_min</span> <span class="kw">&lt;-</span> <span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>(<span class="no">feat_count</span> * <span class="fl">0.4</span>)

<span class="no">xgb_params</span> <span class="kw">&lt;-</span>
  <span class="no">xgb_wflow</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dials</span><span class="kw ns">::</span><span class="fu"><a href="https://dials.tidymodels.org/reference/parameters.html">parameters</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">stats</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span>(
    <span class="kw">mtry</span> <span class="kw">=</span> <span class="kw pkg">dials</span><span class="kw ns">::</span><span class="fu"><a href="https://dials.tidymodels.org/reference/mtry.html">mtry</a></span>(<span class="kw">range</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">mtry_min</span>, <span class="no">feat_count</span>)),
    <span class="kw">sample_size</span> <span class="kw">=</span> <span class="kw pkg">dials</span><span class="kw ns">::</span><span class="fu"><a href="https://dials.tidymodels.org/reference/trees.html">sample_prop</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="fl">1</span>)),
    <span class="kw">tree_depth</span> <span class="kw">=</span> <span class="kw pkg">dials</span><span class="kw ns">::</span><span class="fu"><a href="https://dials.tidymodels.org/reference/trees.html">tree_depth</a></span>(<span class="kw">range</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4L</span>, <span class="fl">10L</span>))
  )</pre></body></html></div>
<p>Now that the range of the parameters has been set, a grid of possible values between those ranges can be created with <code><a href="https://dials.tidymodels.org/reference/grid_max_entropy.html">dials::grid_max_entropy()</a></code>, <em>“to construct parameter grids that try to cover the parameter space such that any portion of the space has an observed combination that is not too far from it.”</em></p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1645</span>)

<span class="no">xgb_grid</span> <span class="kw">&lt;-</span>
  <span class="no">xgb_params</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dials</span><span class="kw ns">::</span><span class="fu"><a href="https://dials.tidymodels.org/reference/grid_max_entropy.html">grid_max_entropy</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">10</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">sample_size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>(<span class="no">sample_size</span>))

<span class="no">xgb_grid</span>
<span class="co">#&gt; # A tibble: 10 x 4</span>
<span class="co">#&gt;     mtry min_n tree_depth sample_size</span>
<span class="co">#&gt;    &lt;int&gt; &lt;int&gt;      &lt;int&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1    35    40          8       0.854</span>
<span class="co">#&gt;  2    59     5          6       0.625</span>
<span class="co">#&gt;  3    27     5          4       0.998</span>
<span class="co">#&gt;  4    27    35          7       0.601</span>
<span class="co">#&gt;  5    49    37          6       0.548</span>
<span class="co">#&gt;  6    40    26          9       0.678</span>
<span class="co">#&gt;  7    31    35          5       0.856</span>
<span class="co">#&gt;  8    32     8          8       0.581</span>
<span class="co">#&gt;  9    36    10          9       0.837</span>
<span class="co">#&gt; 10    47    13          4       0.524</span></pre></body></html></div>
</div>
<div id="tune-xgboost-model" class="section level2">
<h2 class="hasAnchor">
<a href="#tune-xgboost-model" class="anchor"></a>Tune XGBoost model</h2>
<p>We can now tune the model by <a href="https://www.tidymodels.org/learn/work/tune-svm/">searching the grid of parameters</a>.</p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="no">tune_xgb_grid</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/tune_grid.html">tune_grid</a></span>(<span class="no">xgb_wflow</span>,
    <span class="kw">resamples</span> <span class="kw">=</span> <span class="no">folds</span>,
    <span class="kw">grid</span> <span class="kw">=</span> <span class="no">xgb_grid</span>,
    <span class="kw">param_info</span> <span class="kw">=</span> <span class="no">xgb_params</span>,
    <span class="kw">metrics</span> <span class="kw">=</span> <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/metric_set.html">metric_set</a></span>(<span class="no">roc_auc</span>),
    <span class="kw">control</span> <span class="kw">=</span> <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/control_grid.html">control_grid</a></span>(
      <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
      <span class="kw">save_pred</span> <span class="kw">=</span> <span class="fl">TRUE</span>
    )
  )

<span class="no">tune_xgb_grid</span>
<span class="co">#&gt; #  5-fold cross-validation </span>
<span class="co">#&gt; # A tibble: 5 x 5</span>
<span class="co">#&gt;   splits            id    .metrics          .notes           .predictions       </span>
<span class="co">#&gt;   &lt;list&gt;            &lt;chr&gt; &lt;list&gt;            &lt;list&gt;           &lt;list&gt;             </span>
<span class="co">#&gt; 1 &lt;split [640/161]&gt; Fold1 &lt;tibble [10 x 7]&gt; &lt;tibble [0 x 1]&gt; &lt;tibble [1,610 x 8~</span>
<span class="co">#&gt; 2 &lt;split [641/160]&gt; Fold2 &lt;tibble [10 x 7]&gt; &lt;tibble [0 x 1]&gt; &lt;tibble [1,600 x 8~</span>
<span class="co">#&gt; 3 &lt;split [641/160]&gt; Fold3 &lt;tibble [10 x 7]&gt; &lt;tibble [0 x 1]&gt; &lt;tibble [1,600 x 8~</span>
<span class="co">#&gt; 4 &lt;split [641/160]&gt; Fold4 &lt;tibble [10 x 7]&gt; &lt;tibble [0 x 1]&gt; &lt;tibble [1,600 x 8~</span>
<span class="co">#&gt; 5 &lt;split [641/160]&gt; Fold5 &lt;tibble [10 x 7]&gt; &lt;tibble [0 x 1]&gt; &lt;tibble [1,600 x 8~</span></pre></body></html></div>
</div>
<div id="tune-with-iterative-bayesian-optimisation" class="section level2">
<h2 class="hasAnchor">
<a href="#tune-with-iterative-bayesian-optimisation" class="anchor"></a>Tune with iterative Bayesian optimisation</h2>
<p><em>“..iterative search can be used to analyze the existing tuning parameter results and then predict which tuning parameters to try next.”</em> <a href="https://www.tidymodels.org/learn/work/bayes-opt/">see</a></p>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1600</span>)

<span class="no">xgb_bayes_tune</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/tune_bayes.html">tune_bayes</a></span>(<span class="no">xgb_wflow</span>,
    <span class="kw">resamples</span> <span class="kw">=</span> <span class="no">folds</span>,
    <span class="kw">iter</span> <span class="kw">=</span> <span class="fl">5L</span>,
    <span class="kw">param_info</span> <span class="kw">=</span> <span class="no">xgb_params</span>,
    <span class="kw">metrics</span> <span class="kw">=</span> <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/metric_set.html">metric_set</a></span>(<span class="no">roc_auc</span>),
    <span class="kw">initial</span> <span class="kw">=</span> <span class="no">tune_xgb_grid</span>,
    <span class="kw">control</span> <span class="kw">=</span> <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/control_bayes.html">control_bayes</a></span>(
      <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
      <span class="kw">save_pred</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
      <span class="kw">no_improve</span> <span class="kw">=</span> <span class="fl">5L</span>
    )
  )</pre></body></html></div>
</div>
<div id="select-best-model-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#select-best-model-parameters" class="anchor"></a>Select best model parameters</h2>
<p>We can select the hyperparameters giving the best results with <code><a href="https://rdrr.io/pkg/tune/man/show_best.html">tune::select_best()</a></code> according to our chosen metric (area under the ROC curve).</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="no">best_xgb</span> <span class="kw">&lt;-</span>
  <span class="no">xgb_bayes_tune</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/show_best.html">select_best</a></span>(<span class="kw">metric</span> <span class="kw">=</span> <span class="st">"roc_auc"</span>)

<span class="no">best_xgb</span>
<span class="co">#&gt; # A tibble: 1 x 4</span>
<span class="co">#&gt;    mtry min_n tree_depth sample_size</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;      &lt;int&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1    27     5          4       0.998</span></pre></body></html></div>
<p>We now use <code><a href="https://rdrr.io/pkg/tune/man/finalize_model.html">tune::finalize_workflow()</a></code> to generate a workflow object that adds the best performing model.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">best_xgb_wfl</span> <span class="kw">&lt;-</span>
  <span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/finalize_model.html">finalize_workflow</a></span>(<span class="no">xgb_wflow</span>,
    <span class="kw">parameters</span> <span class="kw">=</span> <span class="no">best_xgb</span>
  )
<span class="no">best_xgb_wfl</span>
<span class="co">#&gt; == Workflow ===========================================================================================================================</span>
<span class="co">#&gt; Preprocessor: Recipe</span>
<span class="co">#&gt; Model: boost_tree()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; -- Preprocessor -----------------------------------------------------------------------------------------------------------------------</span>
<span class="co">#&gt; 1 Recipe Step</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; * step_dummy()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; -- Model ------------------------------------------------------------------------------------------------------------------------------</span>
<span class="co">#&gt; Boosted Tree Model Specification (classification)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   mtry = 27</span>
<span class="co">#&gt;   trees = 500</span>
<span class="co">#&gt;   min_n = 5</span>
<span class="co">#&gt;   tree_depth = 4</span>
<span class="co">#&gt;   learn_rate = 0.01</span>
<span class="co">#&gt;   sample_size = 0.997644333867356</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: xgboost</span></pre></body></html></div>
<p>And then generate a fitted model from that workflow on the training data.</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="no">final_fit</span> <span class="kw">&lt;-</span>
  <span class="no">best_xgb_wfl</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">parsnip</span><span class="kw ns">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/reexports.html">fit</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">trainData</span>)

<span class="no">final_fit</span>
<span class="co">#&gt; == Workflow [trained] =================================================================================================================</span>
<span class="co">#&gt; Preprocessor: Recipe</span>
<span class="co">#&gt; Model: boost_tree()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; -- Preprocessor -----------------------------------------------------------------------------------------------------------------------</span>
<span class="co">#&gt; 1 Recipe Step</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; * step_dummy()</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; -- Model ------------------------------------------------------------------------------------------------------------------------------</span>
<span class="co">#&gt; ##### xgb.Booster</span>
<span class="co">#&gt; raw: 387.5 Kb </span>
<span class="co">#&gt; call:</span>
<span class="co">#&gt;   xgboost::xgb.train(params = list(eta = 0.01, max_depth = 4L, </span>
<span class="co">#&gt;     gamma = 0, colsample_bytree = 0.442622950819672, min_child_weight = 5L, </span>
<span class="co">#&gt;     subsample = 0.997644333867356), data = x, nrounds = 500, </span>
<span class="co">#&gt;     verbose = 0, objective = "binary:logistic", nthread = 1)</span>
<span class="co">#&gt; params (as set within xgb.train):</span>
<span class="co">#&gt;   eta = "0.01", max_depth = "4", gamma = "0", colsample_bytree = "0.442622950819672", min_child_weight = "5", subsample = "0.997644333867356", objective = "binary:logistic", nthread = "1", validate_parameters = "TRUE"</span>
<span class="co">#&gt; xgb.attributes:</span>
<span class="co">#&gt;   niter</span>
<span class="co">#&gt; # of features: 61 </span>
<span class="co">#&gt; niter: 500</span>
<span class="co">#&gt; nfeatures : 61</span></pre></body></html></div>
</div>
<div id="variable-importance" class="section level2">
<h2 class="hasAnchor">
<a href="#variable-importance" class="anchor"></a>Variable importance</h2>
<p>The <a href="https://koalaverse.github.io/vip/index.html"><code>{vip}</code></a> package provides variable importance plots. Further methods are well described in the <a href="https://christophm.github.io/interpretable-ml-book/">Interpretable machine learning</a> book.</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="no">final_fit</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">workflows</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/workflows/man/workflow-extractors.html">pull_workflow_fit</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">vip</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/vip/man/vip.html">vip</a></span>(
    <span class="kw">geom</span> <span class="kw">=</span> <span class="st">"col"</span>,
    <span class="kw">num_features</span> <span class="kw">=</span> <span class="fl">12L</span>,
    <span class="kw">include_type</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/var%20imp%20plot%20XGBoost-1.png" width="700"></p>
</div>
<div id="xgboost-performance-on-train" class="section level2">
<h2 class="hasAnchor">
<a href="#xgboost-performance-on-train" class="anchor"></a>XGBoost performance on train</h2>
<p>First we plot the ROC curve for all cut points of the probability of a good loan.</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="no">xgb_train_preds</span> <span class="kw">&lt;-</span> <span class="no">final_fit</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">stats</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(
    <span class="kw">new_data</span> <span class="kw">=</span> <span class="no">trainData</span>,
    <span class="kw">type</span> <span class="kw">=</span> <span class="st">"prob"</span>
  ) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span>(<span class="no">trainData</span> <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">class</span>))

<span class="co"># Generate the full ROC curve</span>
<span class="no">xgb_train_preds</span>$<span class="no">class</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">xgb_train_preds</span>$<span class="no">class</span>)
<span class="no">xgb_roc_curve</span> <span class="kw">&lt;-</span> <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/roc_curve.html">roc_curve</a></span>(<span class="no">xgb_train_preds</span>,
  <span class="kw">truth</span> <span class="kw">=</span> <span class="no">class</span>,
  <span class="no">.pred_good</span>
)

<span class="co"># Get the AUC value and plot the curve</span>
<span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/reexports.html">autoplot</a></span>(<span class="no">xgb_roc_curve</span>) +
  <span class="fu">labs</span>(
    <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(
      <span class="st">"AUC for XGBoost model on train set: %.2f"</span>,
      <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/roc_auc.html">roc_auc</a></span>(<span class="no">xgb_train_preds</span>,
        <span class="kw">truth</span> <span class="kw">=</span> <span class="no">class</span>,
        <span class="no">.pred_good</span>
      ) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(<span class="no">.estimate</span>)
    )
  )</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>To create a confusion matrix requires we select a cut off in the probability to label each record. We use <code><a href="https://rdrr.io/pkg/pROC/man/coords.html">pROC::coords</a></code> from the <a href="https://github.com/xrobin/pROC">pROC</a> package to select the best threshold.</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="co"># calculate best threshold for classification label</span>
<span class="no">my_roc</span> <span class="kw">&lt;-</span> <span class="kw pkg">pROC</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html">roc</a></span>(
  <span class="kw">predictor</span> <span class="kw">=</span> <span class="no">xgb_train_preds</span>$<span class="no">.pred_good</span>,
  <span class="kw">response</span> <span class="kw">=</span> <span class="no">xgb_train_preds</span>$<span class="no">class</span>
)
<span class="no">threshold</span> <span class="kw">&lt;-</span> <span class="kw pkg">pROC</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/pROC/man/coords.html">coords</a></span>(<span class="no">my_roc</span>, <span class="st">"best"</span>, <span class="kw">ret</span> <span class="kw">=</span> <span class="st">"threshold"</span>, <span class="kw">transpose</span> <span class="kw">=</span> <span class="fl">TRUE</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span>()

<span class="no">xgb_train_preds</span> <span class="kw">&lt;-</span>
  <span class="no">xgb_train_preds</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.pred_class</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(
    <span class="no">.pred_good</span> <span class="kw">&gt;=</span> <span class="no">threshold</span> ~ <span class="st">"good"</span>,
    <span class="fl">TRUE</span> ~ <span class="st">"bad"</span>
  )) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.pred_class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">.pred_class</span>))

<span class="co"># confusion matrix</span>
<span class="no">cmat_train</span> <span class="kw">&lt;-</span> <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/conf_mat.html">conf_mat</a></span>(<span class="no">xgb_train_preds</span>,
  <span class="kw">truth</span> <span class="kw">=</span> <span class="st">"class"</span>,
  <span class="kw">estimate</span> <span class="kw">=</span> <span class="st">".pred_class"</span>
)

<span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">cmat_train</span>, <span class="st">"heatmap"</span>)</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>The confusion matrix can be used to generate the performance statistics below. All metrics are impressively high on the training data and superior to Corels. However, this could be due to overfitting. We can now use the test data to test for over fitting.</p>
<div class="sourceCode" id="cb46"><html><body><pre class="r"><span class="co"># https://github.com/tidymodels/yardstick/issues/160</span>
<span class="kw pkg">withr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/withr/man/with_options.html">with_options</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">yardstick.event_first</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">cmat_train</span>)
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">:::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.estimate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">.estimate</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">.metric</span>, <span class="no">.estimate</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">.metric</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"accuracy"</span>, <span class="st">"bal_accuracy"</span>,<span class="st">"mcc"</span>,<span class="st">"precision"</span>, <span class="st">"recall"</span>, <span class="st">"f_meas"</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.estimate</span> <span class="kw">=</span> <span class="kw pkg">formattable</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/formattable/man/color_tile.html">color_tile</a></span>(<span class="st">"white"</span>, <span class="st">"orange"</span>)(<span class="no">.estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">escape</span> <span class="kw">=</span> <span class="no">F</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></body></html></div>
<table class="table table table-hover">
<thead><tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimate
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
accuracy
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffc253">0.833</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
mcc
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.640</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
bal_accuracy
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffc04f">0.838</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffa500">0.927</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffc55b">0.824</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
f_meas
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffb52f">0.873</span>
</td>
</tr>
</tbody>
</table>
</div>
<div id="xgboost-performance-on-test" class="section level2">
<h2 class="hasAnchor">
<a href="#xgboost-performance-on-test" class="anchor"></a>XGBoost performance on test</h2>
<p>In contrast to the training data, the test set performance is much lower for all metrics.</p>
<p>An important evaluation metric is precision. This is because incorrectly labelling bad loans as good has the greatest cost.</p>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="no">xgb_test_preds</span> <span class="kw">&lt;-</span> <span class="no">final_fit</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">stats</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(
    <span class="kw">new_data</span> <span class="kw">=</span> <span class="no">testData</span>,
    <span class="kw">type</span> <span class="kw">=</span> <span class="st">"prob"</span>
  ) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span>(<span class="no">testData</span> <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">class</span>))

<span class="no">xgb_test_preds</span> <span class="kw">&lt;-</span>
  <span class="no">xgb_test_preds</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.pred_class</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(
    <span class="no">.pred_good</span> <span class="kw">&gt;=</span> <span class="no">threshold</span> ~ <span class="st">"good"</span>,
    <span class="fl">TRUE</span> ~ <span class="st">"bad"</span>
  )) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.pred_class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">.pred_class</span>))

<span class="co"># Generate the full ROC curve</span>
<span class="no">xgb_test_preds</span>$<span class="no">class</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">xgb_test_preds</span>$<span class="no">class</span>)
<span class="no">xgb_roc_curve</span> <span class="kw">&lt;-</span> <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/roc_curve.html">roc_curve</a></span>(<span class="no">xgb_test_preds</span>,
  <span class="kw">truth</span> <span class="kw">=</span> <span class="no">class</span>,
  <span class="no">.pred_good</span>
)

<span class="co"># Get the AUC value and plot the curve</span>
<span class="kw pkg">tune</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/tune/man/reexports.html">autoplot</a></span>(<span class="no">xgb_roc_curve</span>) +
  <span class="fu">labs</span>(
    <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(
      <span class="st">"AUC for XGBoost model on test set: %.2f"</span>,
      <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/roc_auc.html">roc_auc</a></span>(<span class="no">xgb_test_preds</span>,
        <span class="kw">truth</span> <span class="kw">=</span> <span class="no">class</span>,
        <span class="no">.pred_good</span>
      ) <span class="kw">%&gt;%</span>
        <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(<span class="no">.estimate</span>)
    )
  )</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/test%20AUC%20XGBoost-1.png" width="700"></p>
<div class="sourceCode" id="cb48"><html><body><pre class="r">
<span class="co"># confusion matrix</span>
<span class="no">cmat_test</span> <span class="kw">&lt;-</span> <span class="kw pkg">yardstick</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/yardstick/man/conf_mat.html">conf_mat</a></span>(<span class="no">xgb_test_preds</span>,
  <span class="kw">truth</span> <span class="kw">=</span> <span class="st">"class"</span>,
  <span class="kw">estimate</span> <span class="kw">=</span> <span class="st">".pred_class"</span>
)

<span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span>(<span class="no">cmat_test</span>, <span class="st">"heatmap"</span>)</pre></body></html></div>
<p><img src="german_credit_data_example_files/figure-html/test%20AUC%20XGBoost-2.png" width="700"></p>
<div class="sourceCode" id="cb49"><html><body><pre class="r">
<span class="co"># https://github.com/tidymodels/yardstick/issues/160</span>
<span class="kw pkg">withr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/withr/man/with_options.html">with_options</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">yardstick.event_first</span> <span class="kw">=</span> <span class="fl">FALSE</span>),
  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">cmat_test</span>)
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">:::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.estimate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">.estimate</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">.metric</span>, <span class="no">.estimate</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">.metric</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"accuracy"</span>, <span class="st">"bal_accuracy"</span>,<span class="st">"mcc"</span>,<span class="st">"precision"</span>, <span class="st">"recall"</span>, <span class="st">"f_meas"</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">.estimate</span> <span class="kw">=</span> <span class="kw pkg">formattable</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/formattable/man/color_tile.html">color_tile</a></span>(<span class="st">"white"</span>, <span class="st">"orange"</span>)(<span class="no">.estimate</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">kable</a></span>(<span class="kw">escape</span> <span class="kw">=</span> <span class="no">F</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></body></html></div>
<table class="table table table-hover">
<thead><tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimate
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
accuracy
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffbc42">0.719</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
mcc
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffffff">0.371</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
bal_accuracy
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffc04d">0.698</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
precision
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffa500">0.841</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
recall
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffb733">0.746</span>
</td>
</tr>
<tr>
<td style="text-align:left;">
f_meas
</td>
<td style="text-align:left;">
<span style="display: block; padding: 0 4px; border-radius: 4px; background-color: #ffae1b">0.791</span>
</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
